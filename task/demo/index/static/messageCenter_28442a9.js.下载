define("common:widget/ui/messageCenter/messageCenter.js",function(require,exports,module){var $messageCenter=T("#message-center"),$panel=T("#message-panel"),$entrance=T(".message-center-entrance"),panelShowed=!1,hasOpertaionCnt=!1,UserMgr=require("common:widget/ui/userMgr/userMgr.js"),style="#message-panel .message-close{width:24px;height:23px;top:0;right:0;position:absolute;background:url(/static/images/op-close.png) no-repeat right 0;cursor:pointer}#message-panel .message-close:hover{background-position:0 0}#op-activity{background:#fff;padding:12px;overflow:hidden;width:333px;position:relative}#op-activity .qrcode-container{float:left;line-height:20px;height:95px;width:75px;margin-right:8px;text-align:center}#op-activity .activity-banner{overflow:hidden}@media only screen and (-webkit-min-device-pixel-ratio:2),(-webkit-min-device-pixel-ratio:2),(min-resolution:2dppx),(min-resolution:192dpi){#message-panel .message-close{background-image:url(/static/images/retina/op-close.png);background-size:auto 23px}}";require.loadCss({content:style,name:"messagepanel"});var style=".scenic3d-panel{line-height:20px;height:346px;width:500px;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;cursor:default}.scenic3d-panel .header{height:145px;background-image:url(//webmap0.bdimg.com/wolfman/static/common/images/scenic3d/hint-pic-1x_7c64a78.png);background-repeat:no-repeat;background-size:500px auto;background-position:0 0;text-align:center;position:relative}.scenic3d-panel .header .title{padding-top:30px;font-size:24px}.scenic3d-panel .header .title span{letter-spacing:1px}.scenic3d-panel .header .title .beta{position:absolute;font-size:12px;top:27px;left:50%;margin-left:44px;height:16px;line-height:16px;width:42px;border:1px solid #e5e5e5;background-color:#fff;border-radius:2px;color:#666}.scenic3d-panel .header .info{padding-top:20px;font-size:16px}.scenic3d-panel .header .info .down{padding-top:4px}.scenic3d-panel .scenic3d-points{display:-webkit-box;display:-ms-flexbox;display:flex;display:-webkit-flex;-webkit-justify-content:space-around;-ms-flex-pack:distribute;justify-content:space-around;padding:0 30px}.scenic3d-panel .scenic3d-points .point{text-decoration:none;cursor:pointer}.scenic3d-panel .scenic3d-points .icon{background-image:url(//webmap0.bdimg.com/wolfman/static/common/images/scenic3d/hint-pic-1x_7c64a78.png);background-repeat:no-repeat;background-size:500px auto;height:115px;width:116px}.scenic3d-panel .scenic3d-points .huaguiyuan .icon{background-position:-53px -156px}.scenic3d-panel .scenic3d-points .qinghuiyuan .icon{background-position:-188px -149px}.scenic3d-panel .scenic3d-points .shijilian .icon{background-position:-327px -162px}.scenic3d-panel .scenic3d-points .name{text-decoration:none;text-align:center;margin:4px auto 0;color:#fff;font-size:14px;height:24px;line-height:24px;background-color:#2f87ff;width:72px;border-radius:2px}.scenic3d-panel .scenic3d-points .shijilian .name{width:110px}@media only screen and (-webkit-min-device-pixel-ratio:2),(-webkit-min-device-pixel-ratio:2),(min-resolution:2dppx),(min-resolution:192dpi){.scenic3d-panel .scenic3d-points .icon,.scenic3d-panel .header{background-image:url(//webmap1.bdimg.com/wolfman/static/common/images/scenic3d/hint-pic-2x_1de3481.png)}}";require.loadCss({content:style,name:"scenic3dpanel"});var messageCenter={init:function(e){var n=this;this.isLogin=e,this.generateContent(function(){n.checkNewMessage(),hasOpertaionCnt||($panel.append('<div class="close-btn-indexpage" title="关闭">&times;</div>'),$panel.append('<div class="login-btn-box"></div>'),$panel.find(".login-btn-box").append(e?'<span href="javscript:;" class="login-btn logined">你已是登录用户</span>':'<a href="javascript:void(0)" class="login-btn need-login msg-tip-dot">立即登录</a>'))}),this.bindEvents(),T("#sbw_map")&&0===parseInt(T("#sbw_map")[0].style.zIndex,10)&&listener.trigger("com.subway","load")},bindEvents:function(){var e=this;$entrance.on("click",function(){panelShowed?e.closePanel():(addStat("ui.messagecenter.clickshow","show"),e.openPanel())}),$panel.on("click",".login-btn.need-login",function(){addStat("ui.messagecenter.login","click"),UserMgr.login(void 0,void 0,"message-center")}),$panel.on("click",".close-btn-indexpage",function(){addStat("ui.messagecenter.clickclose","click"),e.closePanel()}),T("#tool-container").on("click",function(){e.closePanel()}),$panel.on("click",".message-close",function(){e.closePanel()}),$panel.on("click",".point",function(){var e=$(this).data("uid");addStat("gotoscenic3dpage.messagepanel","click"),listener.trigger("toScenic3DPage","click",{uid:e,from:"messagepanel"})}),listener.on("searchbox.search",function(){e.closePanel()}),listener.on("ui.cardmgr","add",function(){e.closePanel()}),listener.on("usercenter.show",function(){e.closePanel()}),listener.on("com.subway","load",function(){$messageCenter.hide(),e.closePanel()}),listener.on("com.subway","unload",function(){e.closePanel(),$messageCenter.show()}),listener.on("ipLocation.correct",function(){e.closePanel()})},getOperationCnt:function(){return new Promise(function(e,n){T.ajax("/fwmap/upload/pc4/message.js",{method:"GET",cache:!1,data:{r:Math.random()},dataType:"json",success:function(t){t&&t.length?e(t):n()},error:function(){n()}})})},processOperationData:function(e){for(var n={operationCnt:[],loginGuide:null},t=e.length-1;t>=0;t--){var a=e[t];a.message_type&&"LOGIN_GUIDE"===a.message_type?n.loginGuide=a:n.operationCnt.push(a)}return n},generateContent:function(cb){function getRandomInt(e,n){return Math.floor(Math.random()*(n-e+1))+e}var template="";template=[function(_template_object){var _template_fun_array=[],fn=function(__data__){var _template_varName="";for(var name in __data__)_template_varName+="var "+name+'=__data__["'+name+'"];';eval(_template_varName),_template_fun_array.push(""),isFirefox?_template_fun_array.push('<img src="',"undefined"==typeof image?"":baidu.template._encodeHTML(image),'"/>'):_template_fun_array.push('<img src="',"undefined"==typeof image?"":baidu.template._encodeHTML(image),'" srcset="',"undefined"==typeof image?"":baidu.template._encodeHTML(image)," 1x, ","undefined"==typeof image_2x?"":baidu.template._encodeHTML(image_2x),' 2x" />'),_template_fun_array.push(""),_template_varName=null}(_template_object);return fn=null,_template_fun_array.join("")}][0];var defaultImage="//webmap0.bdimg.com/wolfman/static/common/images/new/login-guide_ce87a31.png",defaultImage2x="//webmap1.bdimg.com/wolfman/static/common/images/new/login-guide-2x_d9d60e0.png",defaultTpl=template({isFirefox:T.browser.firefox,isLogin:this.isLogin,image:defaultImage,image_2x:defaultImage2x}),me=this,operationCnt=this.getOperationCnt();operationCnt.then(function(data){var res=me.processOperationData(data),item;if(res.operationCnt.length||res.loginGuide){if(me.isLogin&&res.operationCnt.length){hasOpertaionCnt=!0;var importantActivities=res.operationCnt.filter(function(e){return"OP_ACTIVITY"!==e.message_type}),index;importantActivities.length?(index=getRandomInt(1,importantActivities.length)-1,item=importantActivities[index]):(index=getRandomInt(1,res.operationCnt.length)-1,item=res.operationCnt[index])}else item=res.loginGuide;me.renderItem=item,item.caption=item.caption||"";var tpl='<img src="'+item.images+'" alt="'+item.caption+'" />';tpl=T(tpl),item.images_2x&&(T.browser.firefox||tpl.attr("srcset",item.images+" 1x, "+item.images_2x+" 2x")),tpl.on("load",function(){if("OP_ACTIVITY"===item.message_type){var opTemplate=[function(_template_object){var _template_fun_array=[],fn=function(__data__){var _template_varName="";for(var name in __data__)_template_varName+="var "+name+'=__data__["'+name+'"];';eval(_template_varName),_template_fun_array.push('<div id="op-activity">    <div class="qrcode-container">        <p>下载地图APP</p>        <img width="75" height="75" src="',"/static/images/naqrcode.png",'" alt="" srcset="',"/static/images/naqrcode.png"," 1x, ","/static/images/naqrcode2x.png",' 2x"/>    </div>    <div class="activity-banner">    </div></div>'),_template_varName=null}(_template_object);return fn=null,_template_fun_array.join("")}][0],opTpl=opTemplate();opTpl=T(opTpl),tpl.attr("width","250").attr("height","95"),opTpl.find(".activity-banner").append(tpl),$panel.append(opTpl)}else $panel.append(tpl);"LOGIN_GUIDE"!==item.message_type&&$panel.append('<div class="message-close"></div>'),cb()}).on("error",function(){$panel.html(defaultTpl),cb()})}else $panel.html(defaultTpl),cb()},function(){$panel.html(defaultTpl),cb()})},checkNewMessage:function(){return hasOpertaionCnt?void this.hasNoNewMessage():void(this.isLogin?this.hasNoNewMessage():this.hasNewMessage())},hasNewMessage:function(){$messageCenter.addClass("has-message")},hasNoNewMessage:function(){$messageCenter.removeClass("has-message")},openPanel:function(){addStat("ui.messagecenter.show","show"),this.renderItem&&addStat("ui.messagecenter."+this.renderItem.message_type,"show"),$panel.addClass("message-panel-open"),panelShowed=!0},closePanel:function(){addStat("ui.messagecenter.close","click"),$panel.removeClass("message-panel-open"),panelShowed=!1}};module.exports=messageCenter});